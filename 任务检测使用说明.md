# 任务检测使用说明文档

## 概述

本文档详细说明如何使用任务检测系统来验证AI是否成功完成指定的任务。任务检测系统基于两种数据源：
1. **JSON数据文件** - 存储应用状态和数据
2. **任务日志文件** - 记录用户操作和任务完成情况

## 数据文件结构

### 1. JSON数据文件

所有JSON数据文件位于 `app/src/main/assets/data/` 目录下：

#### 购物车数据 (cart_items.json)
```json
[
  {
    "id": "cart_001",
    "product": {
      "id": "iphone15_001",
      "name": "iPhone 15 蓝色 128GB",
      "selectedColor": "蓝色",
      "selectedVersion": "128GB",
      "price": 5999.0
    },
    "quantity": 1,
    "isSelected": true,
    "addedTime": 1704067200000
  }
]
```

#### 订单数据 (orders.json)
```json
[
  {
    "id": "order_001",
    "items": [
      {
        "product": {
          "id": "iphone15_001",
          "name": "iPhone 15 128GB"
        },
        "quantity": 1,
        "selectedColor": "粉色",
        "selectedVersion": "128GB"
      }
    ],
    "status": "PENDING_PAYMENT",
    "totalAmount": 5999.0,
    "createTime": 1704153600000
  }
]
```

#### 地址数据 (addresses.json)
```json
[
  {
    "id": "addr_001",
    "province": "湖北省",
    "city": "武汉市",
    "district": "洪山区",
    "detailAddress": "文秀街9号",
    "isDefault": true,
    "createTime": 1704067200000
  }
]
```

### 2. 任务日志文件 (task_logs.json)

任务日志记录用户的具体操作行为：

```json
[
  {
    "id": "log_001",
    "taskType": "SEARCH",
    "taskDescription": "搜索iPhone 15",
    "action": "搜索操作",
    "details": {
      "searchKeyword": "iPhone 15",
      "searchResultCount": "15",
      "firstProductViewed": "true",
      "firstProductId": "iphone15_001",
      "firstProductName": "iPhone 15 蓝色 128GB"
    },
    "timestamp": 1704067200000,
    "completed": true
  }
]
```

## 任务类型和验证方法

### 数据库检查类任务

这类任务通过检查JSON数据文件来验证：

#### 1. 购物车相关任务
- **verifyAddiPhone15ToCart()** - 检查购物车中是否有iPhone 15 蓝色 128GB
- **verifyAddMultipleiPhone15ToCart()** - 检查多个不同规格的iPhone 15

**验证方法：**
```kotlin
// 检查购物车数据
val cartItems = loadCartItems(context)
val iPhone15Items = cartItems.filter { 
    it.product.name.contains("iPhone 15", ignoreCase = true) &&
    it.product.selectedColor == "蓝色" &&
    it.product.selectedVersion == "128GB"
}
```

#### 2. 订单相关任务
- **verifyPurchaseiPhone15()** - 检查是否存在iPhone 15的订单

**验证方法：**
```kotlin
// 检查订单数据
val orders = loadOrders(context)
val iPhone15Orders = orders.filter { order ->
    order.items.any { item ->
        item.product.name.contains("iPhone 15", ignoreCase = true)
    }
}
```

#### 3. 地址相关任务
- **verifyAddNewAddress()** - 检查是否添加了指定地址并设为默认

**验证方法：**
```kotlin
// 检查地址数据
val addresses = loadAddresses(context)
val wuhanAddress = addresses.find { 
    it.province == "湖北省" && 
    it.city == "武汉市" && 
    it.district == "洪山区" && 
    it.detailAddress.contains("文秀街9号") &&
    it.isDefault
}
```

### 日志检查类任务

这类任务通过检查任务日志文件来验证：

#### 1. 搜索相关任务
- **verifySearchiPhone15()** - 检查是否搜索了iPhone 15并查看第一个商品

**验证方法：**
```kotlin
// 检查搜索日志
val logs = TaskLogger.getAllLogs(context)
val searchLogs = logs.filter { 
    it.taskType == "SEARCH" && 
    it.details["searchKeyword"]?.contains("iPhone 15", ignoreCase = true) == true &&
    it.details["firstProductViewed"] == "true"
}
```

#### 2. 操作相关任务
- **verifyViewAllOrders()** - 检查是否查看了全部订单
- **verifyCheckoutFirstCartItem()** - 检查是否勾选商品并结算
- **verifyPayFirstPendingOrder()** - 检查是否支付了待付款订单

**验证方法：**
```kotlin
// 检查特定操作日志
val logs = TaskLogger.getAllLogs(context)
val viewOrderLogs = logs.filter { 
    it.taskType == "VIEW_ORDERS" && 
    it.details["page"] == "全部订单"
}
```

#### 3. 计算相关任务
- **verifyCountHomeProducts()** - 检查是否计算了首页商品数量
- **verifyCalculateCartTotalPrice()** - 检查是否计算了购物车总价

**验证方法：**
```kotlin
// 检查计算日志
val logs = TaskLogger.getAllLogs(context)
val countLogs = logs.filter { 
    it.taskType == "COUNT_PRODUCTS" && 
    it.details["location"] == "首页"
}
```

### 复合检查类任务

这类任务需要结合多个数据源进行验证：

#### 1. 复杂购买流程
- **verifyComplexSearchAndPurchase()** - 验证搜索+筛选+购买的完整流程
- **verifyComplexStoreNavigation()** - 验证商品详情+店铺+购买的完整流程

**验证方法：**
```kotlin
// 检查复杂操作日志
val logs = TaskLogger.getAllLogs(context)
val complexLogs = logs.filter { 
    it.taskType == "COMPLEX_PURCHASE" &&
    it.details["searchKeyword"]?.contains("iPhone15", ignoreCase = true) == true &&
    it.details["priceRange"] == "5000-8000" 
    // ... 其他条件检查
}
```

## 使用步骤

### 1. 准备工作

确保以下文件存在：
- `app/src/main/assets/data/task_logs.json` - 任务日志文件
- `app/src/main/java/com/example/MyJD/utils/TaskVerifier.kt` - 验证函数库
- `任务判断表.csv` - 任务详细说明

### 2. 执行任务验证

#### 方法一：验证单个任务
```kotlin
// 在Android代码中
val result = TaskVerifier.verifySearchiPhone15(context)
if (result.isCompleted) {
    println("任务完成：${result.message}")
    println("详细信息：${result.details}")
} else {
    println("任务未完成：${result.message}")
}
```

#### 方法二：验证所有任务
```kotlin
// 验证所有任务
val allResults = TaskVerifier.verifyAllTasks(context)
allResults.forEach { (functionName, result) ->
    println("$functionName: ${if (result.isCompleted) "✓" else "✗"} ${result.message}")
}
```

### 3. 查看验证结果

每个验证函数返回`VerificationResult`对象：
```kotlin
data class VerificationResult(
    val isCompleted: Boolean,      // 任务是否完成
    val message: String,           // 结果描述信息
    val details: Map<String, Any>  // 详细信息（可选）
)
```

## 日志记录说明

### 如何添加新的日志记录

在相应的ViewModel或UI组件中调用TaskLogger方法：

```kotlin
// 搜索日志
TaskLogger.logSearchTask(
    context = context,
    keyword = "iPhone 15",
    resultCount = 15,
    firstProductViewed = true,
    firstProductId = "iphone15_001",
    firstProductName = "iPhone 15 蓝色 128GB"
)

// 购物车日志
TaskLogger.logAddToCart(
    context = context,
    productId = "iphone15_001",
    productName = "iPhone 15 蓝色 128GB",
    color = "蓝色",
    version = "128GB",
    quantity = 1,
    price = 5999.0
)

// 购买日志
TaskLogger.logPurchase(
    context = context,
    productId = "iphone15_001",
    productName = "iPhone 15 蓝色 128GB",
    orderId = "order_001",
    color = "蓝色",
    version = "128GB"
)
```

### 支持的日志类型

- **SEARCH** - 搜索操作
- **ADD_TO_CART** - 添加到购物车
- **PURCHASE** - 立即购买
- **VIEW_ORDERS** - 查看订单
- **CHECKOUT_CART** - 购物车结算
- **PAY_ORDER** - 支付订单
- **SEND_MESSAGE** - 发送消息
- **COUNT_PRODUCTS** - 统计商品数量
- **CALCULATE_PRICE** - 计算价格
- **COUNT_ORDERS** - 统计订单数量
- **COUNT_MESSAGES** - 统计消息数量
- **CHECK_DELIVERY** - 查看物流
- **COUNT_COMMENTS** - 统计评论数量
- **COMPLEX_PURCHASE** - 复杂购买流程
- **STORE_NAVIGATION** - 店铺导航
- **CANCEL_ORDERS** - 取消订单
- **ADD_ADDRESS** - 添加地址
- **SET_MESSAGE_MUTE** - 设置消息免打扰

## 常见问题排查

### 1. 验证失败的可能原因

- **数据文件不存在或格式错误** - 检查JSON文件是否存在且格式正确
- **日志记录缺失** - 确认相关操作是否正确调用了TaskLogger
- **条件不匹配** - 检查任务执行时的参数是否符合验证条件

### 2. 调试方法

```kotlin
// 查看所有日志
val allLogs = TaskLogger.getAllLogs(context)
allLogs.forEach { log ->
    println("${log.taskType}: ${log.taskDescription} - ${log.completed}")
}

// 清空日志（测试时使用）
TaskLogger.clearLogs(context)
```

### 3. 性能优化

- 日志文件会随着使用增长，建议定期清理
- 大量验证时建议批量处理而非逐个验证
- 复杂任务验证时注意内存使用

## 扩展和维护

### 添加新任务验证

1. 在`TaskLogger.kt`中添加新的日志记录方法
2. 在`TaskVerifier.kt`中添加对应的验证函数
3. 在`任务判断表.csv`中添加任务描述
4. 在相关UI组件中添加日志记录调用

### 修改现有验证逻辑

1. 更新`TaskVerifier.kt`中的验证条件
2. 同步更新`任务判断表.csv`中的描述
3. 确保相关的日志记录方法输出正确的数据格式

通过这套完整的任务检测系统，可以准确判断AI是否真正完成了指定的任务，确保任务执行的可靠性和准确性。